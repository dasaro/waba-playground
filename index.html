<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Cache-busting handled via ?v= version parameters on module imports -->

    <!-- CRITICAL: Set base URL for GitHub Pages project repository (conditional) -->
    <script>
        // Only set base tag for GitHub Pages, not for localhost
        if (window.location.hostname === 'dasaro.github.io') {
            const base = document.createElement('base');
            base.href = '/waba-playground/';
            document.head.appendChild(base);
        }
    </script>

    <title>WABA Playground - Interactive Framework Explorer</title>
    <link rel="stylesheet" href="style.css">
    <!-- vis.js for network visualization -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/vis-network/styles/vis-network.min.css">

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Configure Emscripten Module BEFORE loading clingo.web.js -->
    <script>
        // Tell Emscripten where to find WASM files on GitHub Pages
        var Module = {
            locateFile: function(path) {
                console.log('[Module.locateFile] Called with path:', path);
                console.log('[Module.locateFile] window.location:', window.location.href);
                console.log('[Module.locateFile] hostname:', window.location.hostname);

                // For WASM files, use absolute URL (critical for GitHub Pages project repos)
                if (path.endsWith('.wasm') || path.endsWith('.worker.js')) {
                    // HARDCODED for GitHub Pages project repo (most reliable)
                    // WASM files are in dist/ subdirectory
                    const isGitHubPages = window.location.hostname === 'dasaro.github.io';
                    const hasProjectPath = window.location.pathname.includes('/waba-playground');

                    console.log('[Module.locateFile] isGitHubPages:', isGitHubPages);
                    console.log('[Module.locateFile] hasProjectPath:', hasProjectPath);

                    if (isGitHubPages && hasProjectPath) {
                        const fullUrl = 'https://dasaro.github.io/waba-playground/dist/' + path;
                        console.log('[Module.locateFile] ‚úì GitHub Pages project mode:', fullUrl);
                        return fullUrl;
                    } else if (isGitHubPages && !hasProjectPath) {
                        // Weird state - on GitHub Pages but not in project path?
                        console.warn('[Module.locateFile] ‚ö†Ô∏è On GitHub Pages but not in project path!');
                        const fullUrl = 'https://dasaro.github.io/waba-playground/dist/' + path;
                        console.log('[Module.locateFile] ‚úì Forcing project path:', fullUrl);
                        return fullUrl;
                    }

                    // Fallback for local development
                    const currentUrl = window.location.href;
                    const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                    const fullUrl = baseUrl + 'dist/' + path;
                    console.log('[Module.locateFile] ‚úì Local mode:', fullUrl);
                    return fullUrl;
                }
                console.log('[Module.locateFile] Passthrough:', path);
                return path;
            }
        };
    </script>
    <script src="clingo.web.js?v=20251227-9"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>WABA Playground</h1>
                <p class="subtitle">Interactive Weighted Assumption-Based Argumentation Framework Explorer</p>
            </div>
            <div class="header-links">
                <button id="font-decrease-btn" class="link-btn" title="Decrease font size" aria-label="Decrease font size">
                    <span style="font-size: 1.2em; font-weight: bold;" aria-hidden="true">‚àí</span>
                </button>
                <button id="font-increase-btn" class="link-btn" title="Increase font size" aria-label="Increase font size">
                    <span style="font-size: 1.2em; font-weight: bold;" aria-hidden="true">+</span>
                </button>
                <button id="theme-toggle-btn" class="link-btn theme-toggle" title="Toggle dark/light mode" aria-label="Toggle dark/light mode">
                    <span id="theme-icon" aria-hidden="true">üåô</span>
                </button>
                <button id="syntax-guide-btn" class="link-btn" title="WABA Syntax Guide" aria-label="Open WABA syntax guide">
                    <span aria-hidden="true">üìñ</span>
                </button>
            </div>
        </div>

        <!-- Introduction Section -->
        <div class="intro-section" id="intro-section">
            <div class="intro-content">
                <p class="intro-status" id="intro-status">‚è≥ Loading Clingo WASM...</p>
                <p class="intro-tagline">
                    <strong>WABA</strong> (Weighted Assumption-Based Argumentation) combines algebraic semirings and monoids
                    to enable flexible reasoning with weighted arguments and budget-constrained attack resolution.
                </p>
                <div class="intro-steps">
                    <span>1Ô∏è‚É£ Configure semiring/monoid</span>
                    <span>2Ô∏è‚É£ Choose example or write framework</span>
                    <span>3Ô∏è‚É£ Run WABA and explore results</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Configuration Panel -->
                <div class="config-panel">
                    <h3>Configuration</h3>

                    <div class="config-grid">
                        <div class="config-item">
                            <label for="semiring-select">Semiring (Weight Propagation)</label>
                            <select id="semiring-select" class="select">
                                <option value="godel">G√∂del (‚äó=min, ‚äï=max)</option>
                                <option value="tropical">Tropical (‚äó=+, ‚äï=min)</option>
                                <option value="arctic">Arctic (‚äó=+, ‚äï=max)</option>
                                <option value="lukasiewicz">≈Åukasiewicz (‚äó=bounded sum, ‚äï=bounded sum)</option>
                                <option value="bottleneck_cost">Bottleneck (‚äó=max, ‚äï=min)</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="monoid-select">Monoid (Cost Aggregation)</label>
                            <select id="monoid-select" class="select">
                                <option value="max">MAX - Minimize/Maximize Worst Attack</option>
                                <option value="sum">SUM - Minimize/Maximize Total Cost</option>
                                <option value="min">MIN - Minimize/Maximize Best Attack</option>
                                <option value="count">COUNT - Minimize/Maximize Attack Count</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="semantics-select">Semantics</label>
                            <select id="semantics-select" class="select">
                                <optgroup label="Core">
                                    <option value="stable">Stable</option>
                                    <option value="cf">Conflict-Free</option>
                                    <option value="admissible">Admissible</option>
                                    <option value="complete">Complete</option>
                                    <option value="grounded">Grounded</option>
                                </optgroup>
                                <optgroup label="Extension-based">
                                    <option value="ideal">Ideal</option>
                                    <option value="naive">Naive</option>
                                    <option value="preferred">Preferred</option>
                                    <option value="semi-stable">Semi-Stable</option>
                                    <option value="staged">Staged</option>
                                </optgroup>
                                <optgroup label="Heuristic">
                                    <option value="heuristic-naive">Naive (heuristic)</option>
                                    <option value="heuristic-preferred">Preferred (heuristic)</option>
                                    <option value="heuristic-semi-stable">Semi-Stable (heuristic)</option>
                                    <option value="heuristic-staged">Staged (heuristic)</option>
                                    <option value="heuristic-grounded">Grounded (heuristic)</option>
                                </optgroup>
                                <optgroup label="OptN">
                                    <option value="optN-preferred">Preferred (optN)</option>
                                    <option value="optN-semi-stable">Semi-Stable (optN)</option>
                                    <option value="optN-staged">Staged (optN)</option>
                                    <option value="optN-ideal">Ideal (optN)</option>
                                    <option value="optN-eager">Eager (optN)</option>
                                    <option value="optN-grounded">Grounded (optN)</option>
                                </optgroup>
                            </select>
                        </div>                    </div>

                    <div class="config-grid">
                        <div class="config-item">
                            <label for="optimize-select">Optimization Direction</label>
                            <select id="optimize-select" class="select">
                                <option value="none">None</option>
                                <option value="minimize" selected>Minimize (Cost Semantics)</option>
                                <option value="maximize">Maximize (Reward Semantics)</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="opt-mode-select">Optimization Mode</label>
                            <select id="opt-mode-select" class="select">
                                <option value="ignore" selected>Enumerate All Extensions</option>
                                <option value="optN">Find Optimal Extensions Only</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="constraint-select">Budget Constraint</label>
                            <select id="constraint-select" class="select">
                                <option value="none" selected>None (Enumerate All)</option>
                                <option value="ub">Upper Bound (cost ‚â§ Œ≤)</option>
                                <option value="lb">Lower Bound (quality ‚â• Œ≤)</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="budget-input">Budget (Œ≤)</label>
                            <input type="number" id="budget-input" class="select" value="100" min="0" max="1000">
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="config-item">
                            <label for="num-models-input">Number of Models (0 = all)</label>
                            <input type="number" id="num-models-input" class="select" value="0" min="0" max="100">
                        </div>

                        <div class="config-item">
                            <label for="example-select">Load Example</label>
                            <select id="example-select" class="select">
                                <option value="">-- Select Example --</option>
                                <option value="simple">Simple - Mixed Attacks</option>
                                <option value="linear">Linear Topology</option>
                                <option value="cycle">Cycle Topology</option>
                                <option value="tree">Tree Topology</option>
                                <option value="complete" selected>Complete Topology</option>
                                <option value="mixed">Mixed Topology</option>
                                <option value="isolated">Isolated Components</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="file-upload-btn">Upload Framework</label>
                            <input type="file" id="file-upload-input" accept=".lp,.waba" style="display: none;">
                            <button id="file-upload-btn" class="select" style="cursor: pointer; text-align: left;">üìÅ Choose File (.lp / .waba)</button>
                        </div>

                        <div class="config-item" style="display: flex; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
                                <input type="checkbox" id="flat-constraint" style="margin: 0;"> Flat-WABA Constraint
                            </label>
                        </div>
                    </div>

                </div>

                <!-- Editor Container -->
                <div class="editor-container">
                    <div class="editor-header">
                        <div class="editor-controls">
                            <h3>Framework Definition</h3>
                            <select id="input-mode" class="select" style="margin-left: 20px;" aria-label="Select input mode">
                                <option value="simple">Simple Mode (ABA)</option>
                                <option value="advanced">Advanced Mode (ASP)</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="run-btn" class="run-btn" aria-label="Execute WABA framework">‚ñ∂Ô∏è Run WABA</button>
                            <button id="download-lp-btn" class="clear-btn" aria-label="Download current framework as .lp file">üíæ .lp</button>
                            <button id="download-waba-btn" class="clear-btn" aria-label="Download current framework as .waba file">üíæ .waba</button>
                        </div>
                    </div>

                    <!-- Advanced Mode: Code Editor -->
                    <textarea id="code-editor" class="code-editor" style="display: none;" placeholder="Enter your WABA framework here...
Example:
assumption(a).
assumption(b).
weight(a, 80).
weight(b, 60).
head(r1, c_a). body(r1, b).
contrary(a, c_a).
contrary(b, c_b)."></textarea>

                    <!-- Simple Mode: Structured Input -->
                    <div id="simple-mode" class="simple-mode">
                        <div class="simple-grid">
                            <div class="simple-field">
                                <label>Assumptions (one per line)</label>
                                <textarea id="assumptions-input" class="simple-textarea" placeholder="a
b
c"></textarea>
                            </div>

                            <div class="simple-field">
                                <label>Rules (format: head <- body1, body2)</label>
                                <textarea id="rules-input" class="simple-textarea" placeholder="c_a <- b"></textarea>
                            </div>

                            <div class="simple-field">
                                <label>Contraries (format: assumption: contrary)</label>
                                <textarea id="contraries-input" class="simple-textarea" placeholder="a: c_a
b: c_b"></textarea>
                            </div>

                            <div class="simple-field">
                                <label>Weights (format: atom: weight)</label>
                                <textarea id="weights-input" class="simple-textarea" placeholder="a: 80
b: 60
c_a: 70"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Graph Visualization -->
                <div class="graph-container" id="graph-container">
                    <div class="graph-header">
                        <h3>Argumentation Graph</h3>
                        <div class="graph-mode-selector">
                            <label class="mode-option">
                                <input type="radio" name="graph-mode" value="standard">
                                <span>Standard</span>
                            </label>
                            <label class="mode-option">
                                <input type="radio" name="graph-mode" value="assumption-direct" checked>
                                <span>Assumption-Direct</span>
                            </label>
                            <label class="mode-option">
                                <input type="radio" name="graph-mode" value="assumption-branching">
                                <span>Assumption-Branching</span>
                            </label>
                        </div>
                        <div class="graph-controls">
                            <button id="reset-layout-btn" class="clear-btn" aria-label="Reset graph layout">üîÑ Reset Layout</button>
                            <button id="fullscreen-btn" class="clear-btn" aria-label="Toggle fullscreen mode">‚õ∂ Fullscreen</button>
                            <button id="legend-toggle-btn" class="clear-btn" aria-label="Toggle graph legend" aria-expanded="false">üìñ Legend</button>
                            <button id="export-png-btn" class="clear-btn" aria-label="Export graph as PNG">üíæ PNG</button>
                            <button id="export-pdf-btn" class="clear-btn" aria-label="Export graph as PDF">üìÑ PDF</button>
                        </div>
                    </div>

                    <!-- Graph Legend (Collapsible) -->
                    <div id="graph-legend" class="graph-legend" role="region" aria-label="Graph visualization legend" hidden>
                        <div class="legend-section">
                            <h4>Node Types</h4>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <span class="legend-symbol node-assumption" aria-hidden="true"></span>
                                    <span>Assumption</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-symbol node-derived" aria-hidden="true"></span>
                                    <span>Joint Attack Node</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-symbol node-top" aria-hidden="true"></span>
                                    <span>‚ä§ (Facts)</span>
                                </div>
                            </div>
                        </div>
                        <div class="legend-section">
                            <h4>Edge Types</h4>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <span class="legend-symbol edge-derived" aria-hidden="true"></span>
                                    <span>Attack</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-symbol edge-joint" aria-hidden="true"></span>
                                    <span>Joint Attack</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-symbol edge-fact" aria-hidden="true"></span>
                                    <span>Fact-based Attack</span>
                                </div>
                            </div>
                        </div>
                        <div class="legend-section">
                            <h4>Attack States</h4>
                            <div class="legend-items">
                                <div class="legend-item">
                                    <span class="legend-symbol edge-active" aria-hidden="true"></span>
                                    <span>Active Attack</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-symbol edge-discarded" aria-hidden="true"></span>
                                    <span>Discarded Attack</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="cy" class="graph-canvas" role="img" aria-label="Argumentation graph visualization"></div>

                    <!-- Isolated Assumptions Banner -->
                    <div id="isolated-assumptions-banner" class="isolated-assumptions-banner" hidden>
                        <strong>‚ö†Ô∏è Isolated Assumptions:</strong>
                        <span id="isolated-assumptions-list"></span>
                    </div>

                    <!-- Empty State -->
                    <div id="graph-empty-state" class="graph-empty-state" role="status" hidden>
                        <div class="empty-state-icon" aria-hidden="true">üìä</div>
                        <h3>No Graph to Display</h3>
                        <p>Run a WABA framework to visualize the argumentation graph.</p>
                        <p class="empty-state-hint">Click "‚ñ∂Ô∏è Run WABA" above to get started.</p>
                    </div>
                </div>

                <!-- Output Container -->
                <div class="output-container">
                    <div class="output-header">
                        <h3>Results</h3>
                        <button id="clear-btn" class="clear-btn" aria-label="Clear output results">üóëÔ∏è Clear Output</button>
                    </div>
                    <div id="output" class="output" role="log" aria-live="polite" aria-atomic="false">
                        <!-- Output Empty State (inside output panel) -->
                        <div id="output-empty-state" class="output-empty-state" role="status">
                            <div class="empty-state-icon" aria-hidden="true">üìã</div>
                            <h3>No Results Yet</h3>
                            <p>Run a WABA framework to see the output here.</p>
                        </div>
                    </div>
                    <div id="stats" class="stats" role="status" aria-live="polite"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>WABA Playground | Powered by <a href="https://potassco.org/clingo/" target="_blank">Clingo</a> & <a href="https://visjs.github.io/vis-network/" target="_blank">vis.js</a></p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" role="status" aria-live="assertive" hidden>
        <div class="loading-content">
            <div class="loading-spinner" aria-hidden="true"></div>
            <h3 id="loading-text">Running WABA...</h3>
            <p id="loading-subtext">Computing extensions and visualizing results</p>
        </div>
    </div>

    <!-- Syntax Guide Modal -->
    <div id="syntax-guide-modal" class="modal" role="dialog" aria-labelledby="syntax-guide-title" aria-hidden="true" hidden>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="syntax-guide-title">WABA Syntax Guide</h2>
                <button id="syntax-guide-close" class="modal-close" aria-label="Close syntax guide">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Simple Mode (.waba Format)</h3>
                <p>Simple Mode uses a structured text format with four sections. Inline comments use <code>%</code> (same as ASP).</p>

                <h4>1. Assumptions</h4>
                <pre><code>a
b
c</code></pre>
                <p>One assumption per line. These are defeasible atoms that can be in or out of extensions.</p>

                <h4>2. Rules</h4>
                <pre><code>conclusion ‚Üê premise1, premise2
attack_element ‚Üê a</code></pre>
                <p>One rule per line using <code>‚Üê</code> (or <code>&lt;-</code>) to separate head from body. Premises separated by commas.</p>

                <h4>3. Contraries</h4>
                <pre><code>a: attack_element
b: conclusion</code></pre>
                <p>Format: <code>attacked_assumption: attacking_element</code><br>
                <strong>Important:</strong> <code>attacking_element</code> attacks <code>attacked_assumption</code> (not the reverse).</p>

                <h4>4. Weights</h4>
                <pre><code>a: 10
b: 20
attack_element: 15</code></pre>
                <p>Format: <code>atom: weight</code>. Assigns positive integer weights (default: 1).</p>

                <h4>Complete .waba Example</h4>
                <pre><code>% Assumptions:
a
b

% Rules:
attack_element ‚Üê a

% Contraries:
b: attack_element

% Weights:
a: 10
b: 20
attack_element: 15</code></pre>
                <p><em>Note:</em> Section headers (Assumptions, Rules, etc.) are commented with <code>%</code> to allow inline comments throughout the file.</p>

                <h3>Advanced Mode (.lp Format)</h3>
                <p>Advanced Mode uses ASP syntax with WABA predicates:</p>

                <h4>Assumptions</h4>
                <pre><code>assumption(atom_name).</code></pre>

                <h4>Weights</h4>
                <pre><code>weight(atom_name, weight_value).</code></pre>

                <h4>Rules (Inference)</h4>
                <pre><code>head(rule_id, conclusion).
body(rule_id, premise1).
body(rule_id, premise2).</code></pre>
                <p><em>Compact form:</em> <code>head(r1, conclusion; r1, premise1; r1, premise2).</code></p>

                <h4>Contraries (Attack Relation)</h4>
                <pre><code>contrary(attacked_assumption, attacking_element).</code></pre>

                <h4>Budget Constraint</h4>
                <pre><code>budget(beta).</code></pre>

                <h4>Complete .lp Example</h4>
                <pre><code>% Assumptions
assumption(a).
assumption(b).

% Weights
weight(a, 10).
weight(b, 20).
weight(attack_element, 15).

% Rules
head(r1, attack_element).
body(r1, a).

% Contraries
contrary(b, attack_element).

% Budget
budget(50).</code></pre>

                <h3>File Upload</h3>
                <p>You can upload <strong>.waba</strong> files (Simple Mode format) or <strong>.lp</strong> files (Advanced Mode ASP format). The playground will automatically detect the format and switch to the appropriate mode.</p>

                <h3>See Also</h3>
                <p>For complete WABA documentation, visit the <a href="https://github.com/dasaro/WABA" target="_blank">WABA GitHub repository</a>.</p>
            </div>
        </div>
    </div>

    <!-- Main Application (ES6 Module) -->
    <!-- Cache-busting: increment version to force reload after changes -->
    <script type="module" src="app.js?v=20260101-1"></script>
</body>
</html>
